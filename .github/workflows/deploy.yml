name: ğŸš€ Deploy DigiUrban Unified System

concurrency:
  group: digiurban-unified-production-deploy
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '72.60.10.108'
  VPS_USER: 'root'
  APP_DIR: '/root/digiurban-unified'
  APP_PORT: '3020'
  CONTAINER_NAME: 'digiurban-unified'

jobs:
  deploy:
    name: ğŸ¯ Deploy Unified Container
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: ğŸ“‹ InformaÃ§Ãµes do Deploy
      run: |
        echo "=============================================="
        echo "ğŸš€ INICIANDO DEPLOY DIGIURBAN UNIFIED SYSTEM"
        echo "=============================================="
        echo "ğŸ“¦ Commit: ${{ github.sha }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "â° Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        echo "ğŸ¯ Target: ${{ env.VPS_HOST }}:${{ env.APP_PORT }}"
        echo "=============================================="
        
        # VariÃ¡vel para tracking do tempo
        echo "DEPLOY_START_TIME=$(date +%s)" >> $GITHUB_ENV

    - name: ğŸ”§ Configurar SSH
      run: |
        echo "ğŸ”§ Configurando SSH..."
        sudo apt-get install -y sshpass
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

    - name: ğŸ“¥ Checkout do CÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0






    - name: ğŸ§¹ Limpeza de Containers Antigos
      timeout-minutes: 5
      run: |
        echo "ğŸ§¹ Removendo containers e imagens antigas..."
        echo "============================================"
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        echo 'ğŸ›‘ Parando TODOS os containers DigiUrban...'
        
        # Parar containers da arquitetura antiga (se existirem)
        docker stop digiurban-frontend digiurban-backend 2>/dev/null && echo 'âœ… Containers antigos parados' || echo 'â„¹ï¸  Nenhum container antigo'
        docker rm digiurban-frontend digiurban-backend 2>/dev/null && echo 'âœ… Containers antigos removidos' || echo 'â„¹ï¸  Nenhum container antigo para remover'
        
        # Parar container unificado atual
        docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null && echo 'âœ… Container unificado parado' || echo 'â„¹ï¸  Nenhum container unificado rodando'
        docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null && echo 'âœ… Container unificado removido' || echo 'â„¹ï¸  Nenhum container unificado para remover'
        
        echo 'ğŸ—‘ï¸  Removendo TODAS as imagens DigiUrban...'
        docker rmi digiurban-frontend:latest digiurban-backend:latest digiurban-unified:latest 2>/dev/null && echo 'âœ… Imagens antigas removidas' || echo 'â„¹ï¸  Nenhuma imagem antiga para remover'
        
        echo 'ğŸ§½ Limpeza especÃ­fica de Docker...'
        docker image prune -f --filter until=24h || echo 'âš ï¸ NÃ£o foi possÃ­vel limpar imagens antigas'
        docker container prune -f || echo 'âš ï¸ NÃ£o foi possÃ­vel limpar containers parados'
        echo 'âœ… Limpeza especÃ­fica concluÃ­da'
        
        echo 'ğŸ“ Preparando diretÃ³rio...'
        rm -rf ${{ env.APP_DIR }}
        mkdir -p ${{ env.APP_DIR }}
        echo 'âœ… DiretÃ³rio preparado'
        "

    - name: ğŸ“¤ Transferir CÃ³digo para VPS
      run: |
        echo "ğŸ“¤ Transferindo cÃ³digo para VPS..."
        echo "=================================="
        
        echo "ğŸ“Š Analisando arquivos a transferir..."
        echo "Tamanho total: $(du -sh . | cut -f1)"
        
        echo "ğŸš€ Iniciando transferÃªncia..."
        if sshpass -p "${{ secrets.VPS_PASSWORD }}" rsync -avz --progress --delete \
          --exclude='.git/' \
          --exclude='node_modules/' \
          --exclude='frontend/node_modules/' \
          --exclude='backend/node_modules/' \
          --exclude='.claude/' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./ ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.APP_DIR }}/; then
          echo "âœ… CÃ³digo transferido com sucesso"
        else
          echo "âŒ Falha na transferÃªncia"
          exit 1
        fi

    - name: ğŸ³ Deploy Container Completo
      run: |
        echo "ğŸ³ Deployando container (inclui setup automÃ¡tico do banco)..."
        echo "============================================================="

        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        cd ${{ env.APP_DIR }}

        echo 'ğŸ“‹ Verificando estrutura transferida...'
        ls -la

        echo 'ğŸ” Verificando arquivos essenciais...'
        ls -la Dockerfile docker-compose.yml start-services.sh scripts/ 2>/dev/null || echo 'âš ï¸ Verificando arquivos...'

        echo 'âœ… Tornando scripts executÃ¡veis...'
        chmod +x start-services.sh scripts/*.sh 2>/dev/null || echo 'â„¹ï¸  Scripts configurados'

        echo 'ğŸ—ï¸ Construindo container (isso pode levar alguns minutos)...'
        if docker compose build --no-cache; then
          echo 'âœ… Container construÃ­do com sucesso'
        else
          echo 'âŒ Falha na construÃ§Ã£o do container'
          exit 1
        fi

        echo 'ğŸš€ Iniciando container (setup automÃ¡tico do banco incluÃ­do)...'
        if docker compose up -d; then
          echo 'âœ… Container iniciado - setup do banco executando automaticamente'
        else
          echo 'âŒ Falha ao iniciar container'
          exit 1
        fi

        echo 'ğŸ“Š Status dos containers:'
        docker compose ps
        "

    - name: â³ Aguardar Sistema Estabilizar
      run: |
        echo "â³ Aguardando sistema estabilizar (setup automÃ¡tico do banco)..."
        echo "=============================================================="

        echo "ğŸ”„ Container estÃ¡ executando start-services.sh automaticamente:"
        echo "   ğŸ“ Criando diretÃ³rios"
        echo "   ğŸ—ƒï¸ Configurando banco de dados"
        echo "   ğŸŒ± Executando seeds"
        echo "   ğŸ”“ Ativando usuÃ¡rios"
        echo "   ğŸš€ Iniciando PM2 e Nginx"

        echo ""
        echo "â³ Aguardando conclusÃ£o do setup (90 segundos)..."
        sleep 90

    - name: ğŸ¥ Health Check Simples
      run: |
        echo "ğŸ¥ Verificando sistema..."

        # Aguardar sistema estabilizar
        sleep 30

        # Health Check API
        for i in {1..8}; do
          if curl -f http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/api/health >/dev/null 2>&1; then
            echo "âœ… API funcionando"
            break
          else
            echo "â³ Aguardando API ($i/8)..."
            sleep 15
          fi

          if [ $i -eq 8 ]; then
            echo "âŒ API nÃ£o respondeu"
            exit 1
          fi
        done

        # Health Check Frontend
        if curl -f http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/ >/dev/null 2>&1; then
          echo "âœ… Frontend funcionando"
        else
          echo "âŒ Frontend falhou"
          exit 1
        fi

        echo "âœ… Sistema validado"


    - name: ğŸ“Š RelatÃ³rio Final
      if: always()
      run: |
        echo "ğŸ“Š RELATÃ“RIO FINAL DO DEPLOY"
        echo "=========================="
        echo "ğŸ¯ Ambiente: ProduÃ§Ã£o"
        echo "ğŸŒ URL: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}"
        echo "ğŸ“… Deploy: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        echo "ğŸ“¦ Commit: ${{ github.sha }}"
        echo "âœ… Status: DEPLOY CONCLUÃDO"

    - name: âœ… VerificaÃ§Ã£o Final
      if: success()
      run: |
        DEPLOY_END_TIME=$(date +%s)
        DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
        DURATION_FORMATTED=$(printf '%02d:%02d:%02d' $((DEPLOY_DURATION/3600)) $((DEPLOY_DURATION%3600/60)) $((DEPLOY_DURATION%60)))

        echo "ğŸ‰ DEPLOY CONCLUÃDO COM SUCESSO!"
        echo "================================"
        echo "â±ï¸  Tempo total: $DURATION_FORMATTED"
        echo "ğŸŒ AplicaÃ§Ã£o: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}"
        echo "ğŸ¥ Health Check: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/api/health"
        echo "ğŸ“Š Status: ONLINE âœ…"
        echo ""
        echo "ğŸŠğŸŠğŸŠ DEPLOY FINALIZADO COM SUCESSO! ğŸŠğŸŠğŸŠ"

    - name: âŒ Deploy Failed
      if: failure()
      run: |
        DEPLOY_END_TIME=$(date +%s)
        DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
        DURATION_FORMATTED=$(printf '%02d:%02d:%02d' $((DEPLOY_DURATION/3600)) $((DEPLOY_DURATION%3600/60)) $((DEPLOY_DURATION%60)))

        echo "âŒ DEPLOY FALHOU!"
        echo "=================="
        echo "â±ï¸  Tempo atÃ© falha: $DURATION_FORMATTED"
        echo "ğŸ“Š Status: FAILED âŒ"
        echo ""
        echo "ğŸ’¥ğŸ’¥ğŸ’¥ DEPLOY FALHOU ğŸ’¥ğŸ’¥ğŸ’¥"

        exit 1